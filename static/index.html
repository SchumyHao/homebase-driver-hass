<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://s.rokidcdn.com/homebase/upload/rJ_Hu5JrS.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <title>HASS login</title>

</head>

<body>
  <div class="container">
    <form class="needs-validation" novalidate>
      <h1>HASS 绑定</h1>
      <div class="form-group">
        <label for="url">URL</label>
        <input type="url" class="form-control" id="url" required aria-describedby="emailHelp"
          placeholder="输入你的 Hass 接口访问地址">
        <small id="emailHelp" class="form-text text-muted">HASS访问地址</small>
      </div>
      <div id="authTypeToggle" class="btn-group mb-2 btn-group-toggle" role="group" data-toggle="buttons" aria-label="Basic example">
        <label class="btn btn-secondary active">
            <input type="radio" name="authType" id="radioPassword" value="password" autocomplete="off" checked> 使用密码
        </label>
        <label class="btn btn-secondary">
          <input type="radio" name="authType" id="radioToken" value="token" autocomplete="off"> 使用Token
        </label>
      </div>
      <div class="form-group" id="fgPass">
        <input type="text" class="form-control" id="inputPassword" placeholder="PassWord">
      </div>
      <div class="form-group d-none" id="fgToken">
        <input type="text" class="form-control" id="inputToken" placeholder="Token">
      </div>

      <button type="submit" class="btn btn-primary">绑定</button>
    </form>
  </div>
  <script>
    (function(){
      'use strict';
      window.addEventListener('load', function() {
        const radios = document.querySelectorAll('input[name="authType"][type=radio]')
        const theForm = document.querySelector('form')
        var authType
        radios.forEach(el => {
          el.parentElement.addEventListener('click', function (ev) {
            setTimeout(function(){
              updateValidate()
            }, 100)
          })
        })
        function updateValidate() {
          radios.forEach(elem => {
            if (elem.checked) {
              authType = elem.value
            }
          })

          if (authType === 'password') {
            document.querySelector('#fgPass').classList.remove('d-none')
            document.querySelector('#fgPass input').required = true
            document.querySelector('#fgToken').classList.add('d-none')
            document.querySelector('#fgToken input').required = false
          } else {
            document.querySelector('#fgPass').classList.add('d-none')
            document.querySelector('#fgPass input').required = false
            document.querySelector('#fgToken').classList.remove('d-none')
            document.querySelector('#fgToken input').required = true
          }
        }

        updateValidate()

        theForm.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            theForm.classList.add('was-validated');
            if (theForm.checkValidity() === false) {
              console.error('not valid')
            } else {
              const url = location.search
              const tokenObj = {
                url: document.querySelector('#url').value,
                type: authType,
              }
              if (tokenObj.type === 'token') {
                tokenObj.token = document.querySelector('#inputToken').value
              } else if (tokenObj.type === 'password') {
                tokenObj.password = document.querySelector('#inputPassword').value
              }
              const query = location.search.substr(1).split('&').reduce(function(o, pair){
                const p = pair.split('=')
                if (p.length) {
                  o[p[0]] = p[1] ? decodeURIComponent(p[1]) : undefined
                }
                return o
              }, {})
              const search = "userId=hass&userToken=" + encodeURIComponent(btoa(JSON.stringify(tokenObj)))
              location.href = query.callbackURL + (/\?/.test(query.callbackURL) ? '&' : '?') + search
            }
          }, false);
      }, false);
    })()
  </script>
</body>

</html>